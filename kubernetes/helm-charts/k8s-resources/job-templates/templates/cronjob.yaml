{{- range $jobName, $job := .Values.jobs }}
{{- if $job.enabled | default true }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: job-template-{{ $jobName }}
  namespace: {{ $job.namespace | default $.Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ $.Chart.Name }}
    app.kubernetes.io/instance: {{ $.Release.Name }}
    app.kubernetes.io/component: job-template
    job-template: {{ $jobName }}
spec:
  suspend: true
  schedule: "0 0 1 1 *"
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $.Chart.Name }}
        app.kubernetes.io/instance: {{ $.Release.Name }}
        app.kubernetes.io/component: job
        job-template: {{ $jobName }}
    spec:
      {{- if $job.backoffLimit }}
      backoffLimit: {{ $job.backoffLimit }}
      {{- end }}
      {{- if $job.activeDeadlineSeconds }}
      activeDeadlineSeconds: {{ $job.activeDeadlineSeconds }}
      {{- end }}
      template:
        metadata:
          labels:
            app.kubernetes.io/name: {{ $.Chart.Name }}
            app.kubernetes.io/instance: {{ $.Release.Name }}
            app.kubernetes.io/component: job-pod
            job-template: {{ $jobName }}
        spec:
          restartPolicy: {{ $job.restartPolicy | default "Never" }}
          {{- if $job.serviceAccountName }}
          serviceAccountName: {{ $job.serviceAccountName }}
          {{- end }}
          {{- if $job.volumes }}
          volumes:
          {{- range $job.volumes }}
          - name: {{ .name }}
            {{- if .configMap }}
            configMap:
              name: {{ .configMap.name }}
              {{- if .configMap.defaultMode }}
              defaultMode: {{ .configMap.defaultMode }}
              {{- end }}
              {{- if .configMap.items }}
              items:
              {{- range .configMap.items }}
              - key: {{ .key }}
                path: {{ .path }}
              {{- end }}
              {{- end }}
            {{- else if .secret }}
            secret:
              secretName: {{ .secret.secretName }}
              {{- if .secret.defaultMode }}
              defaultMode: {{ .secret.defaultMode }}
              {{- end }}
              {{- if .secret.items }}
              items:
              {{- range .secret.items }}
              - key: {{ .key }}
                path: {{ .path }}
              {{- end }}
              {{- end }}
            {{- else if .persistentVolumeClaim }}
            persistentVolumeClaim:
              claimName: {{ .persistentVolumeClaim.claimName }}
            {{- else if .emptyDir }}
            emptyDir:
              {{- if .emptyDir.sizeLimit }}
              sizeLimit: {{ .emptyDir.sizeLimit }}
              {{- end }}
            {{- else if .hostPath }}
            hostPath:
              path: {{ .hostPath.path }}
              {{- if .hostPath.type }}
              type: {{ .hostPath.type }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- end }}
          containers:
          - name: {{ $jobName }}
            image: {{ $job.image.repository }}:{{ $job.image.tag }}
            {{- if $job.image.pullPolicy }}
            imagePullPolicy: {{ $job.image.pullPolicy }}
            {{- end }}
            {{- if $job.command }}
            command:
            {{- range $job.command }}
            - {{ . | quote }}
            {{- end }}
            {{- end }}
            {{- if $job.args }}
            args:
            {{- range $job.args }}
            - {{ . | quote }}
            {{- end }}
            {{- end }}
            {{- if $job.env }}
            env:
            {{- $job.env | toYaml | nindent 2 }}
            {{- end }}
            {{- if $job.volumeMounts }}
            volumeMounts:
            {{- range $job.volumeMounts }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if $job.resources }}
            resources:
              {{- if $job.resources.requests }}
              requests:
                {{- if $job.resources.requests.memory }}
                memory: {{ $job.resources.requests.memory }}
                {{- end }}
                {{- if $job.resources.requests.cpu }}
                cpu: {{ $job.resources.requests.cpu }}
                {{- end }}
              {{- end }}
              {{- if $job.resources.limits }}
              limits:
                {{- if $job.resources.limits.memory }}
                memory: {{ $job.resources.limits.memory }}
                {{- end }}
                {{- if $job.resources.limits.cpu }}
                cpu: {{ $job.resources.limits.cpu }}
                {{- end }}
              {{- end }}
            {{- end }}
{{- end }}
{{- end }}