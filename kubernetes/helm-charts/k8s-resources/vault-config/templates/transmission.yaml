{{- if index .Values "transmission" "enabled" }}
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: transmission-auth
  namespace: videos
spec:
  method: kubernetes
  mount: kubernetes
  kubernetes:
    role: vpn
    serviceAccount: transmission
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: transmission-config-secret
  namespace: videos
spec:
  type: kv-v2
  mount: videos
  path: vpn/config

  destination:
    name: vpn-config-secret
    create: true

    transformation:
      templates:
        vpnConfig:
          text: |
            {{`{{ .Secrets.value | regexReplaceAll "\\\\n" "\n" }}`}}

  refreshAfter: 30s

  vaultAuthRef: transmission-auth
{{- end }}
