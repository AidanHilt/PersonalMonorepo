apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  description: "Central Postgres cluster for staging-cluster"
  instances: 2
  startDelay: 300
  stopDelay: 300
  primaryUpdateStrategy: unsupervised

  superuserSecret:
    name: postgres-config

  enableSuperuserAccess: true

  storage:
    size: 10Gi

  initContainers:
    - name: wait-for-secret
      image: bitnami/kubectl:latest
      command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          echo "Waiting for secret postgres-config to exist..."

          while ! kubectl get secret postgres-config -n $(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace) 2>/dev/null; do
            echo "Secret not found, waiting 5 seconds..."
            sleep 5
          done

          echo "Secret found! Proceeding with cluster creation."
