# Bootstrapping a NixOS server

By far, the worst part of setting up a NixOS machine is bootstrapping it. It's not so bad when you have access to a machine and can copy and paste out of it, but it gets trickier when you want to set your stuff up remotely. The best way to handle this is to have a simple procedure that makes you think as little as possible, and is well-rehearsed. Here's my attempt at one.

1. **Install basic software and configuration**
    * ```curl https://raw.githubusercontent.com/AidanHilt/PersonalMonorepo/refs/heads/feat/staging-cluster-setup/nix/server-setup/bootstrap/configuration-${platform}.nix > /etc/nixos/configuration.nix```   
    This will add a few tools we'll use later in the process to our `configuration.nix`. This needs to be run with some kind of root access. In this case, `${platform}` is a choice between `vbox` (meaning an x86 virtual machine running on local hardware), or nothing else right now.
    * ```nixos-rebuild switch```  
    Actually applies our new configuration.nix. You shouldn't even need to reboot! Make sure to add a `sudo` if you're not running as root 
2. **Grab config information**
    * We'll very least need the filesystem mounts. Everything under `fileSystems` in `/etc/nixos/hardware-configuration.nix` will need to be grabbed and added to the `server-setup` flake.
    * If you run into issues getting the next step to work, check `/etc/nixos/configuration.nix` for any sneaky platform-specific parts that may have been missed. Hopefully, we've seen a platform before, so double check step 1 to make sure you grabbed the right platform. 
3. **Set up the host keys and secrets**
    * The host key should have already been generated by step 1, so you should be able to grab it with `cat /etc/ssh/ssh_host_ed25519_key.pub`. Go ahead put that into `<PERSONAL_MONOREPO_PATH>/nix/secrets/secrets.nix`, and give the key access to any secrets it may need. 
    * If this is the first machine of a new cluster, make sure to get the token into nix secrets management. `cat /var/lib/rancher/rke2/server/token` to get the right token, then `cd` into `<PERSONAL_MONOREPO_PATH>/nix/secrets/` and edit a file with the appropriate name. Make sure to add that file to `secrets.nix` so it can be edited properly.
4. **Final Instal**
    * Once all your changes are committed and in git, you can go ahead and run `install-flake` to upgrade from the basic configuration to the flake. After that, any time updates are commited to git, you can run the command `update` to run the nix update process. 